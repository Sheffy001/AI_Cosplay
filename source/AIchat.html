<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>AI 角色扮演聊天</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f5f5f5;
    }

    /* 左侧栏 */
    .sidebar {
      width: 260px;
      background: #2f3542;
      color: white;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 15px;
      background: #374151;
      border-bottom: 1px solid #444;
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .sidebar-header small {
      font-size: 12px;
      color: #aaa;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .chat-item {
      padding: 10px;
      margin-bottom: 5px;
      background: #3a3f47;
      border-radius: 5px;
      cursor: pointer;
    }

    .chat-item:hover {
      background: #4a5568;
    }

    /* 右侧聊天 */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 15px;
    }

    .message.user {
      text-align: right;
    }

    .message.user .content {
      display: inline-block;
      background-color: #0084ff;
      color: white;
      padding: 10px;
      border-radius: 10px;
    }

    /* 修改机器人消息样式 */
    .message.assistant {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .message.assistant .content {
      background-color: #e5e5ea;
      color: black;
      padding: 10px;
      border-radius: 10px;
      flex: 1;
      min-width: 0;
    }

    /* 喇叭按钮样式 */
    .speaker-btn {
      background: #4CAF50;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 5px;
      flex-shrink: 0;
      /* 防止按钮被压缩 */
      transition: all 0.2s;
    }

    .speaker-btn:hover {
      background: #45a049;
      transform: scale(1.1);
    }

    .speaker-btn:active {
      transform: scale(0.95);
    }

    .speaker-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .input-container {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ccc;
    }

    .input-container input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .input-container button {
      margin-left: 10px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #0084ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .input-container button:hover {
      background-color: #006bbf;
    }
  </style>
  <script>
    const currentUser = {};
  </script>
</head>

<body>
  <!-- 左侧栏 -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3 id="username"></h3>
      <small id="user-info"></small>
    </div>
    <div class="chat-list" id="chat-list"><!-- 自动加载，不进行硬编码 --></div>
  </div>

  <!-- 右侧聊天区 -->
  <div class="chat-container">
    <div class="chat-messages" id="chat-messages"></div>
    <div class="input-container">
      <input type="text" id="user-input" placeholder="请输入消息..." />
      <button id="send-button">发送</button>
      <button id="mic-button">🎤</button>
    </div>
  </div>


  <script>
    const roleVoiceMap = {};
    async function loadRoleList() {
      try {
        const resp = await fetch("/role", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type: "mult", roleid: "0" })
        });

        if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
        const data = await resp.json();
        if (!data.success) throw new Error("获取角色列表失败");

        const chatListDiv = document.getElementById("chat-list");

        // 清空原有HTML硬编码项
        chatListDiv.innerHTML = "";

        // 遍历接口返回，创建列表项并绑定点击事件
        data.roleinfo.forEach(role => {
          const div = document.createElement("div");
          div.classList.add("chat-item");
          div.dataset.chatid = role.roleid;
          div.textContent = role.rolename;

          // 点击事件
          div.addEventListener("click", () => {
            loadChat(role.roleid);
          });

          chatListDiv.appendChild(div);

          // 保存语音类型映射
          roleVoiceMap[role.roleid] = role.voicetype || "qiniu_zh_female_tmjxxy";
        });

        roleVoiceMap["default"] = "qiniu_zh_female_tmjxxy";

        // 默认加载第一个角色聊天
        if (data.roleinfo.length > 0) {
          await loadChat(data.roleinfo[0].roleid);
        }
      } catch (err) {
        console.error("加载角色列表失败:", err);
      }
    }
    loadRoleList();
    // const chatListDiv = document.getElementById('chat-list');
    const chatMessagesDiv = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');


    let currentChatId = null;
    let conversationHistory = [];
    

    // 修改渲染消息函数
    function addMessage(content, sender, showSpeaker = true) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);

      const contentDiv = document.createElement('div');
      contentDiv.classList.add('content');
      contentDiv.textContent = content;

      if (sender === 'assistant' && showSpeaker) {
        // 为机器人消息添加喇叭按钮
        const speakerBtn = document.createElement('button');
        speakerBtn.classList.add('speaker-btn');
        speakerBtn.innerHTML = '🔊';
        speakerBtn.title = '点击播放语音';

        speakerBtn.addEventListener('click', function () {
          speakerBtn.disabled = true;
          speakerBtn.innerHTML = '⏳';
          speakerBtn.title = '正在播放...';

          speakTTS(content, currentChatId).finally(() => {
            speakerBtn.disabled = false;
            speakerBtn.innerHTML = '🔊';
            speakerBtn.title = '点击播放语音';
          });
        });

        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(speakerBtn);
      } else {
        messageDiv.appendChild(contentDiv);
      }

      chatMessagesDiv.appendChild(messageDiv);
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }
    //gushihuoqu
    async function getRoleDefaultMessage(chatId) {
      try {
        const storyResp = await fetch("/role", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ roleid: chatId, type: "signal" })
        });

        if (!storyResp.ok) throw new Error(`HTTP error! status: ${storyResp.status}`);
        const storyData = await storyResp.json();

        if (!storyData.success) {
          console.warn("未找到该角色故事");
          return null; // 或者 return ""
        }

        return storyData.roleinfo;

      } catch (err) {
        console.error("获取角色故事失败:", err);
        return null;
      }
    }
    async function getRoleStroy(chatId) {
      try {
        const storyResp = await fetch("/story", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ roleid: chatId })
        });

        if (!storyResp.ok) throw new Error(`HTTP error! status: ${storyResp.status}`);
        const storyData = await storyResp.json();

        if (!storyData.success) {
          console.warn("未找到该角色故事");
          return null; // 或者 return ""
        }

        return storyData.story;

      } catch (err) {
        console.error("获取角色故事失败:", err);
        return null; // 出错时返回 null，调用方自己处理
      }
    }



    


    // 加载历史聊天
    async function loadChat(chatId) {
      currentChatId = chatId;
      chatMessagesDiv.innerHTML = '';
      if (!currentUser.userId) {
        try {
          const userResp = await fetch("/userinfo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}) // 后端不需要请求体可为空
          });

          if (!userResp.ok) throw new Error(`HTTP error! status: ${userResp.status}`);
          const userData = await userResp.json();

          if (!userData.success) {
            alert("用户未登录或 Session 已过期");
            window.location.href = "/login.html";
            return;
          }

          // 保存用户信息到全局 currentUser
          currentUser.userId = userData.userId;
          currentUser.username = userData.username;
          currentUser.maxchatid = userData.maxchatid;

          // 更新左侧栏显示
          document.getElementById("username").innerText = "用户: " + currentUser.username;
          document.getElementById("user-info").innerText =
            "UID: " + currentUser.userId + " | maxChatId: " + currentUser.maxchatid;

        } catch (err) {
          console.error("获取用户信息失败:", err);
          alert("获取用户信息失败，请检查网络或重新登录");
          window.location.href = "/login.html";
          return;
        }
      }

      const roleStory = await getRoleStroy(currentChatId);
      conversationHistory = [{
        role: "system",
        content: `现在你是下面这个故事的主角，请以主角视角和我聊天：${roleStory}`
      }];

      try {
        const resp = await fetch('/history', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userid: currentUser.userId, chatid: currentChatId })
        });
        const data = await resp.json();
        const history = data.messages || [];

        if (history.length > 0) {
          // 数据库有消息
          history.forEach(msg => {
            addMessage(msg.message, msg.role === 'user' ? 'user' : 'assistant');
            conversationHistory.push({ role: msg.role, content: msg.message });
          });
        } else {
          // 没有消息，渲染默认开场白
          const defaultMsg = await getRoleDefaultMessage(currentChatId) || "默认开场白";
          addMessage(defaultMsg, 'assistant');
          conversationHistory.push({ role: 'assistant', content: defaultMsg });
        }
      } catch (err) {
        console.error('加载历史消息失败', err);
        const defaultMsg = getRoleDefaultMessage(currentChatId);
        addMessage(defaultMsg, 'assistant');
        conversationHistory.push({ role: 'assistant', content: defaultMsg });
      }
    }

    // 保存消息到服务器
    async function saveMessage(userMessage, botMessage) {
      try {
        await fetch('/Save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userid: currentUser.userId,
            chatid: currentChatId,
            user_message: userMessage,
            bot_message: botMessage
          })
        });
      } catch (err) {
        console.error('保存失败:', err);
        alert('消息保存失败，请检查网络连接');
      }
    }

    function filterDialogue(text) {
      // 去掉 *xxx* 或 [xxx]
      return text.replace(/(\*.*?\*|\[.*?\])/g, "").trim();
    }

    // 发送消息（修改后的版本）
    async function sendMessage() {
      if (!currentChatId) { alert("请先选择一个角色"); return; }
      const message = userInput.value.trim();
      if (!message) return;
      addMessage(message, 'user');
      conversationHistory.push({ role: "user", content: message });
      userInput.value = '';

      const replyDiv = document.createElement('div');
      replyDiv.classList.add('message', 'bot');
      const replyContent = document.createElement('div');
      replyContent.classList.add('content');
      replyDiv.appendChild(replyContent);
      chatMessagesDiv.appendChild(replyDiv);

      try {
        const qiniuResp = await fetch("https://openai.qiniu.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "sk-646dfa7895e2b087d59916715de791794f8782f060e661222342aef5b920491a"
          },
          body: JSON.stringify(
            {
              model: "gpt-oss-120b",
              messages: conversationHistory,
              stream: true
            }
          )
        });

        if (!qiniuResp.ok) {
          throw new Error(`HTTP error! status: ${qiniuResp.status}`);
        }

        const reader = qiniuResp.body.getReader();
        const decoder = new TextDecoder("utf-8");
        replyContent.textContent = "";
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          let lines = buffer.split("\n");
          buffer = lines.pop();

          for (let line of lines) {
            line = line.trim();
            if (!line.startsWith("data:")) continue;

            const jsonStr = line.replace(/^data:\s*/, "");
            if (jsonStr === "[DONE]") continue;

            try {
              const data = JSON.parse(jsonStr);
              const content = data.choices?.[0]?.delta?.content;
              if (content) {
                replyContent.textContent += content;
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
              }


            } catch (e) {
              // JSON不完整，下一轮再处理
            }
          }
        }

        // 流式回复完成后，为这个消息添加喇叭按钮
        const speakerBtn = document.createElement('button');
        speakerBtn.classList.add('speaker-btn');
        speakerBtn.innerHTML = '🔊';
        speakerBtn.title = '点击播放语音';

        speakerBtn.addEventListener('click', function () {
          speakerBtn.disabled = true;
          speakerBtn.innerHTML = '⏳';
          speakerBtn.title = '正在播放...';

          speakTTS(replyContent.textContent, currentChatId).finally(() => {
            speakerBtn.disabled = false;
            speakerBtn.innerHTML = '🔊';
            speakerBtn.title = '点击播放语音';
          });
        });

        replyDiv.appendChild(speakerBtn);

        // 自动播放一次
        speakTTS(replyContent.textContent, currentChatId);
        conversationHistory.push({ role: "assistant", content: replyContent.textContent });

        // 调用独立的保存函数
        await saveMessage(message, replyContent.textContent);

      } catch (err) {
        console.error(err);
        replyContent.textContent = "抱歉，AI 生成失败";
      }
    }

    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

    const micButton = document.getElementById('mic-button');

    // 语音输入
    let recognizing = false;
    let recognition;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'zh-CN'; // 中文
      recognition.continuous = false; // 一次识别一次
      recognition.interimResults = false;

      recognition.onstart = () => { recognizing = true; micButton.textContent = '🎙️ 录音中...'; };
      recognition.onend = () => { recognizing = false; micButton.textContent = '🎤'; };
      recognition.onerror = (e) => { console.error(e); recognizing = false; micButton.textContent = '🎤'; };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript; // 填入输入框
        sendMessage(); // 自动发送，可删除改为手动点击发送
      };
    }

    micButton.addEventListener('click', () => {
      if (!recognition) {
        alert('你的浏览器不支持语音识别');
        return;
      }
      if (recognizing) {
        recognition.stop();
      } else {
        recognition.start();
      }
    });




    // 修改TTS函数，返回Promise以便处理完成状态
    async function speakTTS(text, chatId) {
      const voiceType = roleVoiceMap[chatId] || roleVoiceMap["default"];
      try {
        const resp = await fetch("https://openai.qiniu.com/v1/voice/tts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer sk-646dfa7895e2b087d59916715de791794f8782f060e661222342aef5b920491a"
          },
          body: JSON.stringify({
            audio: {
              voice_type: voiceType,
              encoding: "mp3",
              speed_ratio: 1.3,
            },
            request: { text }
          })
        });

        if (!resp.ok) {
          throw new Error(`七牛云 TTS 请求失败，status: ${resp.status}`);
        }

        const data = await resp.json();
        const base64Audio = data.data; // TTS 返回的 base64 音频
        const audio = new Audio("data:audio/mp3;base64," + base64Audio);

        return new Promise((resolve, reject) => {
          audio.onended = resolve;
          audio.onerror = reject;
          audio.play();
        });

      } catch (err) {
        console.error("TTS 播放失败:", err);
        // 失败时可回退到浏览器 TTS
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.pitch = 1;
        utterance.rate = 1;

        return new Promise((resolve) => {
          utterance.onend = resolve;
          speechSynthesis.speak(utterance);
        });
      }
    }

  </script>

</body>

</html>